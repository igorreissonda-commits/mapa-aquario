<script>
        // ======================================================
        // CONFIGURAÃ‡ÃƒO
        // ======================================================
        const URL_API = "https://script.google.com/macros/s/AKfycby41mDV3a-yw5HSEyRPvBg1IDEQSLqW4JE9wbcRr6I-Ou_Apb10uFPW03FwbY5vs7A9/exec"; 
        
        const mesasB1 = [70, 71, 72, 73, 74, 85, 86, 87, 88, 89, 100, 101, 102, 103, 104, 109, 108, 107, 106, 105];
        const mesasB2 = [65, 66, 67, 68, 69, 80, 81, 82, 83, 84, 95, 96, 97, 98, 99, 114, 113, 112, 111, 110];
        const mesasB3 = [60, 61, 62, 63, 64, 75, 76, 77, 78, 79, 90, 91, 92, 93, 94, 119, 118, 117, 116, 115];

        let dadosDB = {}; 
        let perfilUsuario = ""; 

        async function iniciarSistema() {
            try {
                const resp = await fetch(URL_API);
                if (!resp.ok) throw new Error("Erro HTTP");
                dadosDB = await resp.json();
                console.log("Dados carregados:", dadosDB);
                document.getElementById('tela-loading').style.display = 'none';
                document.getElementById('tela-login').style.display = 'flex';
            } catch (err) {
                alert("Erro ao conectar na planilha. Tente atualizar a pÃ¡gina.");
            }
        }

        function fazerLogin() {
            const u = document.getElementById('user').value.trim().toLowerCase();
            const p = document.getElementById('pass').value;
            const labelUser = document.getElementById('nome-usuario');
            const boxAdmin = document.getElementById('legenda-admin');
            const boxVisit = document.getElementById('legenda-visitante');
            
            let loginSucesso = false;

            boxAdmin.style.display = 'none';
            boxVisit.style.display = 'none';

            if (u === "admin" && p === "Sogodajuda") {
                perfilUsuario = "admin";
                labelUser.innerHTML = "ðŸ› ï¸ ADMINISTRADOR";
                labelUser.style.color = "#4CAF50";
                boxAdmin.style.display = 'block';
                loginSucesso = true;
            } 
            else if (u === "gestÃ£o natura" && p === "Natura26") {
                perfilUsuario = "gestao";
                labelUser.innerHTML = "ðŸ‘¤ GESTÃƒO NATURA";
                labelUser.style.color = "#00bcd4";
                boxAdmin.style.display = 'block'; 
                loginSucesso = true;
            } 
            else if (u === "visitante" && p === "visitaae") {
                perfilUsuario = "visitante";
                labelUser.innerHTML = "ðŸ‘€ VISITANTE";
                labelUser.style.color = "#FFC107";
                boxVisit.style.display = 'block';
                loginSucesso = true;
            } 
            else {
                document.getElementById('erro-login').style.display = 'block';
                return;
            }

            if (loginSucesso) {
                // --- MUDANÃ‡A: FORÃ‡AR A TROCA IMEDIATAMENTE ---
                document.body.style.backgroundImage = "url('fundo.jpg')";

                // Verificador de erro (SÃ³ para te avisar se o nome estiver errado)
                const imgTeste = new Image();
                imgTeste.src = 'fundo.jpg';
                imgTeste.onerror = function() {
                    alert("âš ï¸ AVISO: A imagem 'fundo.jpg' nÃ£o foi encontrada no GitHub!\n\nVerifique se o nome do arquivo no GitHub estÃ¡ exatamente 'fundo.jpg' (tudo minÃºsculo).");
                };

                document.getElementById('tela-login').style.display = 'none';
                document.getElementById('app-principal').style.display = 'block';
                renderizarMesas();
            }
        }

        function renderizarMesas() {
            criarBloco("bloco1", mesasB1);
            criarBloco("bloco2", mesasB2);
            criarBloco("bloco3", mesasB3);
        }

        function criarBloco(idDiv, listaMesas) {
            const container = document.getElementById(idDiv);
            container.innerHTML = "";

            listaMesas.forEach(num => {
                const mesa = document.createElement('div');
                mesa.className = 'mesa';
                mesa.innerText = num;

                const infoAdmin = dadosDB[num];
                const infoGestao = dadosDB["G_" + num];

                if (infoAdmin && infoAdmin.status !== 'LIVRE') {
                    mesa.style.backgroundColor = infoAdmin.cor;
                }

                if ((perfilUsuario === 'admin' || perfilUsuario === 'gestao') && infoGestao) {
                    if (infoGestao.status === 'Permitido') mesa.classList.add('borda-permitido');
                    if (infoGestao.status === 'Proibido') mesa.classList.add('borda-proibido');
                }

                const btnX = document.createElement('div');
                btnX.className = 'btn-limpar';
                btnX.innerText = 'X';
                mesa.appendChild(btnX);

                if (perfilUsuario === 'admin' && infoAdmin && infoAdmin.status !== 'LIVRE') {
                    btnX.style.display = 'block';
                }
                if (perfilUsuario === 'gestao' && infoGestao && infoGestao.status !== 'LIVRE') {
                    btnX.style.display = 'block';
                }

                if (perfilUsuario === 'visitante') {
                    mesa.classList.add('bloqueada');
                } else {
                    btnX.addEventListener('click', (e) => {
                        e.stopPropagation();
                        fecharMenus();
                        let key = (perfilUsuario === 'gestao') ? "G_" + num : num;
                        salvarDados(key, "transparent", "LIVRE");
                        delete dadosDB[key];
                        btnX.style.display = 'none';
                        if (perfilUsuario === 'admin') mesa.style.backgroundColor = 'rgba(60, 60, 60, 0.95)';
                        if (perfilUsuario === 'gestao') mesa.classList.remove('borda-permitido', 'borda-proibido');
                    });

                    mesa.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (e.target === btnX) return;
                        fecharMenus();
                        abrirMenu(mesa, num, btnX);
                    });
                }
                container.appendChild(mesa);
            });
        }

        function abrirMenu(elementoMesa, numero, btnX) {
            const menu = document.createElement('div');
            menu.className = 'menu-cores';
            let opcoes = [];
            
            if (perfilUsuario === 'gestao') {
                opcoes = [
                    { cls: 'bg-green', hex: '#28a745', txt: 'Permitido' },
                    { cls: 'bg-red', hex: '#dc3545', txt: 'Proibido' }
                ];
            } else if (perfilUsuario === 'admin') {
                opcoes = [
                    { cls: 'bg-green', hex: '#28a745', txt: 'Formatado' },
                    { cls: 'bg-red', hex: '#dc3545', txt: 'NÃ£o formatado' },
                    { cls: 'bg-yellow', hex: '#ffc107', txt: 'Sem Atendimento' }
                ];
            }

            opcoes.forEach(opt => {
                const bolinha = document.createElement('div');
                bolinha.className = 'opcao-cor ' + opt.cls;
                bolinha.title = opt.txt;
                bolinha.addEventListener('click', (e) => {
                    e.stopPropagation();
                    let key = (perfilUsuario === 'gestao') ? "G_" + numero : numero;
                    salvarDados(key, opt.hex, opt.txt);
                    dadosDB[key] = { cor: opt.hex, status: opt.txt };

                    if (perfilUsuario === 'admin') {
                        elementoMesa.style.backgroundColor = opt.hex;
                    } else if (perfilUsuario === 'gestao') {
                        elementoMesa.classList.remove('borda-permitido', 'borda-proibido');
                        if (opt.txt === 'Permitido') elementoMesa.classList.add('borda-permitido');
                        if (opt.txt === 'Proibido') elementoMesa.classList.add('borda-proibido');
                    }
                    btnX.style.display = 'block';
                    fecharMenus();
                });
                menu.appendChild(bolinha);
            });
            elementoMesa.appendChild(menu);
        }

        function salvarDados(key, cor, status) {
            dadosDB[key] = { cor: cor, status: status };
            fetch(URL_API, {
                method: "POST",
                mode: "no-cors",
                body: JSON.stringify({ mesa: key, cor: cor, status: status }),
                headers: { "Content-Type": "application/json" }
            }).catch(e => console.error("Erro ao salvar:", e));
        }

        function fecharMenus() {
            document.querySelectorAll('.menu-cores').forEach(m => m.remove());
        }

        document.addEventListener('click', fecharMenus);

        iniciarSistema();
    </script>
